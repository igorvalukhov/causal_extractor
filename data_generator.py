"""
Генератор синтетических данных v1.
словари причин и следствий жёстко разбиты на
train/val/test непересекающиеся части - модель не может «вспомнить»
фразу, она обязана научиться находить её по контексту (коннектору).
"""

import random
import json
from typing import List, Dict, Tuple

# ─────────────────────────────────────────────────────────────────
# ПОЛНЫЕ словари (120 причин, 120 следствий)
# ─────────────────────────────────────────────────────────────────

ALL_CAUSES = [
    # --- блок 1 (train) ---
    ["сильный", "дождь"],
    ["проливной", "ливень"],
    ["затяжные", "дожди"],
    ["аномальная", "жара"],
    ["продолжительная", "засуха"],
    ["резкое", "похолодание"],
    ["сильные", "морозы"],
    ["усиленные", "тренировки"],
    ["регулярные", "физические", "нагрузки"],
    ["хроническое", "недосыпание"],
    ["систематический", "недосып"],
    ["плохое", "питание"],
    ["несбалансированный", "рацион"],
    ["постоянный", "стресс"],
    ["нервное", "перенапряжение"],
    ["финансовый", "кризис"],
    ["глубокий", "экономический", "кризис"],
    ["резкое", "повышение", "налогов"],
    ["введение", "новых", "налогов"],
    ["падение", "потребительского", "спроса"],
    ["серьёзный", "технический", "сбой"],
    ["критическая", "ошибка", "в", "программе"],
    ["утечка", "персональных", "данных"],
    ["высокий", "уровень", "инфляции"],
    ["стремительный", "рост", "инфляции"],
    ["крупная", "авария", "на", "заводе"],
    ["жёсткие", "экономические", "санкции"],
    ["вспышка", "инфекционного", "заболевания"],
    ["острая", "нехватка", "сырья"],
    ["конфликт", "интересов", "в", "руководстве"],
    ["мощный", "взрыв", "на", "объекте"],
    ["масштабный", "пожар", "в", "здании"],
    ["ураганный", "ветер"],
    ["катастрофическое", "наводнение"],
    ["полный", "неурожай"],
    ["хронический", "дефицит", "бюджета"],
    ["резкое", "повышение", "ключевой", "ставки"],
    ["сильное", "загрязнение", "воды"],
    ["обвальное", "падение", "акций"],
    ["массовые", "сокращения", "персонала"],
    # --- блок 2 (val) ---
    ["затяжной", "экономический", "спад"],
    ["резкое", "сокращение", "финансирования"],
    ["технологическая", "авария"],
    ["природный", "катаклизм"],
    ["системный", "сбой", "оборудования"],
    ["длительная", "забастовка", "рабочих"],
    ["резкий", "рост", "стоимости", "энергоносителей"],
    ["обострение", "геополитической", "обстановки"],
    ["массовый", "отток", "капитала"],
    ["введение", "торговых", "ограничений"],
    ["нарушение", "цепочек", "поставок"],
    ["критический", "дефицит", "кадров"],
    ["волна", "кибератак"],
    ["резкое", "падение", "курса", "валюты"],
    ["ужесточение", "регуляторных", "требований"],
    ["потеря", "ключевых", "поставщиков"],
    ["банкротство", "крупного", "партнёра"],
    ["изменение", "климатических", "условий"],
    ["длительное", "отключение", "электроэнергии"],
    ["серьёзный", "дефицит", "воды"],
    # --- блок 3 (test) ---
    ["рост", "мировых", "цен", "на", "нефть"],
    ["глобальный", "финансовый", "кризис"],
    ["масштабное", "землетрясение"],
    ["ядерная", "авария"],
    ["резкий", "рост", "преступности"],
    ["массовая", "миграция", "населения"],
    ["разрушение", "критической", "инфраструктуры"],
    ["длительная", "пандемия"],
    ["резкий", "дефицит", "продовольствия"],
    ["потеря", "доступа", "к", "технологиям"],
    ["распад", "производственного", "кластера"],
    ["снижение", "инвестиционной", "активности"],
    ["деградация", "почвенного", "покрова"],
    ["утрата", "биоразнообразия"],
    ["обострение", "социальной", "напряжённости"],
    ["рост", "уровня", "коррупции"],
    ["снижение", "качества", "образования"],
    ["деградация", "здравоохранения"],
    ["потеря", "конкурентоспособности"],
    ["системный", "управленческий", "кризис"],
]

ALL_EFFECTS = [
    # --- блок 1 (train) ---
    ["масштабное", "наводнение"],
    ["затопление", "жилых", "кварталов"],
    ["полная", "гибель", "урожая"],
    ["уничтожение", "посевов"],
    ["резкое", "ухудшение", "погодных", "условий"],
    ["заметное", "улучшение", "физической", "формы"],
    ["значительный", "прогресс", "в", "тренировках"],
    ["резкое", "снижение", "концентрации"],
    ["ухудшение", "когнитивных", "функций"],
    ["серьёзное", "ухудшение", "здоровья"],
    ["развитие", "хронических", "заболеваний"],
    ["профессиональное", "выгорание"],
    ["волна", "безработицы"],
    ["резкий", "рост", "числа", "безработных"],
    ["существенное", "снижение", "доходов", "населения"],
    ["падение", "реальных", "доходов"],
    ["массовое", "банкротство", "компаний"],
    ["закрытие", "многих", "предприятий"],
    ["полный", "простой", "производства"],
    ["длительный", "сбой", "в", "работе", "сервиса"],
    ["полная", "утрата", "доверия", "пользователей"],
    ["массовый", "отток", "клиентов"],
    ["резкое", "снижение", "покупательской", "способности"],
    ["массовый", "голод"],
    ["острый", "продовольственный", "кризис"],
    ["острый", "дефицит", "товаров"],
    ["вспышка", "массовых", "заболеваний"],
    ["серьёзная", "задержка", "проекта"],
    ["многочисленные", "судебные", "иски"],
    ["масштабные", "разрушения"],
    ["экстренная", "эвакуация", "жителей"],
    ["серьёзные", "перебои", "в", "электроснабжении"],
    ["полное", "затопление", "территорий"],
    ["стремительный", "рост", "цен", "на", "продукты"],
    ["жёсткое", "сокращение", "государственных", "расходов"],
    ["резкий", "рост", "ставок", "по", "ипотеке"],
    ["обвал", "фондового", "рынка"],
    ["затяжная", "депрессия"],
    ["острый", "бюджетный", "кризис"],
    ["нехватка", "предметов", "первой", "необходимости"],
    # --- блок 2 (val) ---
    ["резкое", "сокращение", "рабочих", "мест"],
    ["рост", "социальной", "напряжённости"],
    ["снижение", "уровня", "жизни"],
    ["ускорение", "инфляции"],
    ["бегство", "инвесторов"],
    ["кризис", "государственного", "управления"],
    ["рост", "внешнего", "долга"],
    ["ослабление", "национальной", "валюты"],
    ["деградация", "инфраструктуры"],
    ["потеря", "международного", "доверия"],
    ["снижение", "ВВП"],
    ["рост", "бедности"],
    ["утечка", "мозгов"],
    ["снижение", "рождаемости"],
    ["рост", "смертности"],
    ["ухудшение", "экологической", "обстановки"],
    ["разрушение", "экосистем"],
    ["снижение", "продовольственной", "безопасности"],
    ["рост", "политической", "нестабильности"],
    ["кризис", "доверия", "к", "власти"],
    # --- блок 3 (test) ---
    ["коллапс", "транспортной", "системы"],
    ["тотальный", "дефицит", "медикаментов"],
    ["распад", "социальных", "институтов"],
    ["крах", "пенсионной", "системы"],
    ["рост", "числа", "беженцев"],
    ["уничтожение", "малого", "бизнеса"],
    ["разрушение", "системы", "образования"],
    ["коллапс", "здравоохранения"],
    ["массовый", "исход", "населения"],
    ["утрата", "продовольственного", "суверенитета"],
    ["глубокий", "демографический", "кризис"],
    ["резкий", "рост", "неравенства"],
    ["деиндустриализация", "экономики"],
    ["разрушение", "научного", "потенциала"],
    ["упадок", "культурной", "жизни"],
    ["ухудшение", "качества", "воздуха"],
    ["нехватка", "питьевой", "воды"],
    ["кризис", "энергетической", "безопасности"],
    ["срыв", "международных", "соглашений"],
    ["кризис", "международного", "права"],
]

# Разбиваем: первые 40 — train, следующие 20 — val, последние 20 — test
TRAIN_CAUSES = ALL_CAUSES[:40]
VAL_CAUSES   = ALL_CAUSES[40:60]
TEST_CAUSES  = ALL_CAUSES[60:]

TRAIN_EFFECTS = ALL_EFFECTS[:40]
VAL_EFFECTS   = ALL_EFFECTS[40:60]
TEST_EFFECTS  = ALL_EFFECTS[60:]

CAUSE_CONNECTORS = [
    ["привёл", "к"], ["вызвал"], ["спровоцировал"], ["стал", "причиной"],
    ["обусловил"], ["породил"], ["повлёк", "за", "собой"],
    ["послужил", "причиной"], ["дал", "толчок", "к"],
    ["привела", "к"], ["вызвала"], ["спровоцировала"],
    ["повлекла", "за", "собой"], ["обернулась"], ["стало", "причиной"],
]

EFFECT_CONNECTORS = [
    ["произошёл", "из-за"], ["возник", "вследствие"], ["стал", "следствием"],
    ["был", "вызван"], ["явился", "результатом"], ["объясняется"],
    ["оказался", "следствием"], ["возникла", "в", "результате"],
    ["стала", "следствием"], ["появился", "из-за"],
    ["произошла", "из-за"], ["возникло", "вследствие"],
    ["оказалась", "следствием"], ["стало", "результатом"],
]

PREFIXES = [
    [], [], [],  # пустой префикс чаще
    ["Учёные", "установили", ",", "что"],
    ["Эксперты", "утверждают", ",", "что"],
    ["По", "данным", "исследования", ","],
    ["Стало", "известно", ",", "что"],
    ["Как", "выяснилось", ","],
    ["Сообщается", ",", "что"],
    ["По", "мнению", "аналитиков", ","],
    ["Специалисты", "отмечают", ",", "что"],
    ["Согласно", "официальным", "данным", ","],
    ["Как", "сообщают", "местные", "СМИ", ","],
]

SUFFIXES = [
    ["."], ["."], ["."],  # точка чаще
    ["в", "этом", "году", "."],
    ["по", "данным", "аналитиков", "."],
    ["согласно", "официальному", "отчёту", "."],
    ["как", "сообщают", "СМИ", "."],
    ["отмечают", "эксперты", "."],
    ["говорится", "в", "докладе", "."],
]

NEUTRAL_SENTENCES = [
    ["Сегодня", "была", "хорошая", "погода", "."],
    ["Команда", "провела", "совещание", "по", "плану", "работ", "."],
    ["На", "рынке", "появились", "новые", "товары", "."],
    ["Специалисты", "изучают", "данную", "проблему", "."],
    ["Организация", "объявила", "о", "новых", "планах", "."],
    ["Исследователи", "продолжают", "работу", "в", "данном", "направлении", "."],
    ["Ситуация", "остаётся", "под", "контролем", "."],
    ["Стороны", "провели", "переговоры", "по", "ключевым", "вопросам", "."],
    ["Правительство", "рассматривает", "различные", "варианты", "решения", "."],
    ["Компания", "представила", "новый", "продукт", "на", "выставке", "."],
    ["Рабочая", "группа", "завершила", "подготовку", "доклада", "."],
    ["Конференция", "собрала", "более", "ста", "участников", "."],
    ["Регулятор", "опубликовал", "ежеквартальный", "отчёт", "."],
    ["Муниципалитет", "утвердил", "новый", "бюджет", "на", "следующий", "год", "."],
    ["Делегация", "прибыла", "для", "проведения", "переговоров", "."],
    ["Министерство", "выпустило", "официальное", "заявление", "."],
    ["Парламент", "принял", "поправки", "к", "закону", "."],
    ["Суд", "вынес", "решение", "по", "резонансному", "делу", "."],
    ["Ведомство", "провело", "плановую", "проверку", "."],
    ["Совет", "директоров", "утвердил", "новую", "стратегию", "."],
]


def bioes_tag(n: int, label: str) -> List[str]:
    if n == 1:
        return [f"S-{label}"]
    return [f"B-{label}"] + [f"I-{label}"] * (n - 2) + [f"E-{label}"]


def _make_sample(cause_pool, effect_pool, pattern: str) -> Dict:
    cause_tokens = random.choice(cause_pool)[:]
    effect_tokens = random.choice(effect_pool)[:]
    while effect_tokens == cause_tokens:
        effect_tokens = random.choice(effect_pool)[:]

    prefix = random.choice(PREFIXES)[:]
    suffix = random.choice(SUFFIXES)[:]

    if pattern == "cause_first":
        conn = random.choice(CAUSE_CONNECTORS)[:]
        tokens = prefix + cause_tokens + conn + effect_tokens + suffix
        cs = len(prefix)
        ce = cs + len(cause_tokens)
        es = ce + len(conn)
        ee = es + len(effect_tokens)
    else:
        conn = random.choice(EFFECT_CONNECTORS)[:]
        tokens = prefix + effect_tokens + conn + cause_tokens + suffix
        es = len(prefix)
        ee = es + len(effect_tokens)
        cs = ee + len(conn)
        ce = cs + len(cause_tokens)

    tags = ["O"] * len(tokens)
    for i, t in enumerate(bioes_tag(len(cause_tokens), "CAUSE")):
        tags[cs + i] = t
    for i, t in enumerate(bioes_tag(len(effect_tokens), "EFFECT")):
        tags[es + i] = t

    return {"tokens": tokens, "tags": tags, "text": " ".join(tokens)}


def generate_split(n_pos: int, n_neg: int,
                   cause_pool, effect_pool) -> List[Dict]:
    data = []
    for _ in range(n_pos):
        pattern = random.choice(["cause_first", "effect_first"])
        data.append(_make_sample(cause_pool, effect_pool, pattern))
    for _ in range(n_neg):
        tokens = random.choice(NEUTRAL_SENTENCES)[:]
        data.append({"tokens": tokens, "tags": ["O"] * len(tokens),
                     "text": " ".join(tokens)})
    random.shuffle(data)
    return data


def generate_dataset(n_samples: int = 5000,
                     neg_ratio: float = 0.2) -> Tuple[List[Dict], List[Dict], List[Dict]]:
    """
    Возвращает (train, val, test) с непересекающимися словарями сущностей.
    """
    n_neg = int(n_samples * neg_ratio)
    n_pos = n_samples - n_neg

    # train: 70%, val: 15%, test: 15%
    tr_pos = int(n_pos * 0.70)
    va_pos = int(n_pos * 0.15)
    te_pos = n_pos - tr_pos - va_pos
    tr_neg = int(n_neg * 0.70)
    va_neg = int(n_neg * 0.15)
    te_neg = n_neg - tr_neg - va_neg

    train = generate_split(tr_pos, tr_neg, TRAIN_CAUSES, TRAIN_EFFECTS)
    val   = generate_split(va_pos, va_neg, VAL_CAUSES,   VAL_EFFECTS)
    test  = generate_split(te_pos, te_neg, TEST_CAUSES,  TEST_EFFECTS)

    return train, val, test


def save_dataset(dataset, path: str):
    with open(path, "w", encoding="utf-8") as f:
        json.dump(dataset, f, ensure_ascii=False, indent=2)
    print(f"Сохранено {len(dataset)} примеров → {path}")


def load_dataset(path: str):
    with open(path, encoding="utf-8") as f:
        return json.load(f)


if __name__ == "__main__":
    random.seed(42)
    train, val, test = generate_dataset(300)
    print(f"train={len(train)} val={len(val)} test={len(test)}")
    s = train[0]
    print("\nПример:")
    for tok, tag in zip(s["tokens"], s["tags"]):
        print(f"  {tok:<45} {tag}")
